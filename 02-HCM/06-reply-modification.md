# Reply Modification in Envoy

## Overview
The **HTTP Connection Manager (HCM)** in Envoy supports **modifying and customizing responses** that are returned by Envoy itself. However, this does not apply to responses returned by an upstream service.

### What Are Local Replies?
Local replies are responses **generated by Envoy** rather than an upstream service. For example, if no routes or upstream clusters are defined, Envoy may return an **HTTP 404**.

To customize these responses, we define a set of **mappers** that apply filters and modify response properties such as **status codes, body content, and headers**.

---
## Local Reply Mappers
Each local reply mapper consists of:
1. **A filter** – Defines matching conditions based on:
   - Status code
   - Response duration
   - Headers
   - Response flags
2. **Modification rules**, including:
   - Status code change (`status_code`)
   - Custom response body (`body`, `body_format_override`)
   - Additional headers (`headers_to_add`)

### Example: Modifying a Local Response
The following configuration rewrites an **HTTP 503** response (service unavailable) to **HTTP 401** (unauthorized):

```yaml
- name: envoy.filters.network.http_connection_manager
  typed_config:
    "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
    mappers:
    - filter:
        status_code_filter:
          comparison:
            op: EQ
            value:
              default_value: 503
      headers_to_add:
        - header:
            key: "service"
            value: "unavailable"
          append: false
      status_code: 401
      body:
        inline_string: "Not allowed"
```

### Explanation:
- **Filter:** Matches responses with status **503** (service unavailable).
- **Headers:** Adds a response header (`service: unavailable`).
- **Status Code Change:** The original 503 is changed to **401** (unauthorized).
- **Custom Body:** Returns "Not allowed" as the response body.

---
## Filtering and Customizing Local Responses
Envoy allows **filtering responses** before applying modifications. Some common **filter types** include:

| **Filter Type**         | **Description** |
|------------------------|----------------|
| **Status Code Filter**  | Matches responses based on HTTP status codes. |
| **Header Filter**       | Matches responses based on specific headers. |
| **Response Flag Filter** | Matches responses based on Envoy's internal response flags. |
| **Duration Filter**      | Matches responses based on how long they took. |

### Example: Filtering Based on Multiple Conditions
The following configuration matches **403 Forbidden** responses, modifies the body, and adds a custom header:

```yaml
mappers:
  - filter:
      status_code_filter:
        comparison:
          op: EQ
          value:
            default_value: 403
    headers_to_add:
      - header:
          key: "x-custom-error"
          value: "forbidden"
        append: false
    status_code: 418
    body:
      inline_string: "I'm a teapot"
```

### Explanation:
- **Filter:** Matches responses with a **403 Forbidden** status code.
- **Header Addition:** Adds `x-custom-error: forbidden`.
- **Status Code Change:** **403** → **418 I'm a teapot**.
- **Custom Body:** Returns the string `"I'm a teapot"`.

---
## Summary
Local reply modifications in Envoy allow fine-grained control over **error handling**, **custom messages**, and **header injection**. By utilizing **status code filters, response flag filters, and header filters**, we can fully customize how Envoy-generated responses behave before reaching the client.

